{% if request.page_type != 'cart' and request.page_type != 'checkout' %}
      <!-- <div id="popupWidgetIcon">
    <img src="https://cdn.shopify.com/s/files/1/0910/8966/6336/files/widget_myloc8.gif?v=1747208969" alt="Subscribe" width="78" height="101">
  </div> -->
    <div id="initialPopModal">
        <div class="popupOverlay">
            <div class="popupWidget">
                 <div class="closeButton">
                    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M4.27404 24.07C2.93689 22.7786 1.87034 21.2338 1.13662 19.5257C0.402889 17.8176 0.016682 15.9806 0.000528595 14.1217C-0.0156248 12.2627 0.338599 10.4192 1.04253 8.69868C1.74646 6.97813 2.78601 5.415 4.10051 4.10051C5.415 2.78601 6.97813 1.74646 8.69868 1.04253C10.4192 0.338599 12.2627 -0.0156248 14.1217 0.000528595C15.9806 0.016682 17.8176 0.402889 19.5257 1.13662C21.2338 1.87034 22.7786 2.93689 24.07 4.27404C26.6202 6.91447 28.0314 10.4509 27.9995 14.1217C27.9676 17.7924 26.4952 21.3038 23.8995 23.8995C21.3038 26.4952 17.7924 27.9676 14.1217 27.9995C10.4509 28.0314 6.91447 26.6202 4.27404 24.07ZM16.132 14.172L20.094 10.21L18.12 8.23603L14.172 12.198L10.21 8.23603L8.23603 10.21L12.198 14.172L8.23603 18.134L10.21 20.108L14.172 16.146L18.134 20.108L20.108 18.134L16.146 14.172H16.132Z"
                            fill="white" />
                    </svg>
                 </div>
                <div class="popLeft">
                    <div class="popContent">
                        <div class="discountHeading">
                            <h2>Get <span>10%</span> Off</h2>
                        </div>
                        <div class="discountCaption">
                            <p>Be the first to know about Myloc8 special offers and news.</p>
                        </div>
                        <div class="emailFields">
                            <input type="email" id="subscriptionEmail" placeholder="Your email address">
                        </div>
                        <div class="subscribeBtn">
                            <input id="subscriptionButton" type="submit" value="SUBSCRIBE">
                            <!-- <input type="submit" value="subscribe"> -->
                        </div>
                        <label class="popTerms" id="popTermss">
                            <input type="checkbox">
                            I agree to the Privacy Policy and to receiving emails from Myloc8
                        </label>
                    </div>
                </div>
                <div class="popSideimage">
                    <img src="https://cdn.shopify.com/s/files/1/0910/8966/6336/files/banner-shirt1_jpg.webp?v=1731580104"
                        alt="">
                </div>
            </div>
        </div>
    </div>
    <div id="confirmationPopModal">
        <div class="popupOverlay">
            <div class="popupWidget">
                 <div class="closeButton">
                    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M4.27404 24.07C2.93689 22.7786 1.87034 21.2338 1.13662 19.5257C0.402889 17.8176 0.016682 15.9806 0.000528595 14.1217C-0.0156248 12.2627 0.338599 10.4192 1.04253 8.69868C1.74646 6.97813 2.78601 5.415 4.10051 4.10051C5.415 2.78601 6.97813 1.74646 8.69868 1.04253C10.4192 0.338599 12.2627 -0.0156248 14.1217 0.000528595C15.9806 0.016682 17.8176 0.402889 19.5257 1.13662C21.2338 1.87034 22.7786 2.93689 24.07 4.27404C26.6202 6.91447 28.0314 10.4509 27.9995 14.1217C27.9676 17.7924 26.4952 21.3038 23.8995 23.8995C21.3038 26.4952 17.7924 27.9676 14.1217 27.9995C10.4509 28.0314 6.91447 26.6202 4.27404 24.07ZM16.132 14.172L20.094 10.21L18.12 8.23603L14.172 12.198L10.21 8.23603L8.23603 10.21L12.198 14.172L8.23603 18.134L10.21 20.108L14.172 16.146L18.134 20.108L20.108 18.134L16.146 14.172H16.132Z"
                            fill="white" />
                    </svg>
                 </div>
                <div class="popLeft">
                    <div class="popContent">
                        <div class="discountHeading">
                            <h2>Please Confirm Your Email</h2>
                        </div>
                        <div class="discountCaption">
                            <p>Check your email for a confirmation link. Just one more step to start receiving updates and special offers!</p>
                        </div>
                    </div>
                </div>
                <div class="popSideimage">
                    <img src="https://cdn.shopify.com/s/files/1/0910/8966/6336/files/look-natural8_jpg.webp?v=1731580080"
                        alt="">
                </div>
            </div>
        </div>
    </div>
    <div id="finalPopModal">
        <div class="popupOverlay">
            <div class="popupWidget">
                 <div class="closeButton">
                    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M4.27404 24.07C2.93689 22.7786 1.87034 21.2338 1.13662 19.5257C0.402889 17.8176 0.016682 15.9806 0.000528595 14.1217C-0.0156248 12.2627 0.338599 10.4192 1.04253 8.69868C1.74646 6.97813 2.78601 5.415 4.10051 4.10051C5.415 2.78601 6.97813 1.74646 8.69868 1.04253C10.4192 0.338599 12.2627 -0.0156248 14.1217 0.000528595C15.9806 0.016682 17.8176 0.402889 19.5257 1.13662C21.2338 1.87034 22.7786 2.93689 24.07 4.27404C26.6202 6.91447 28.0314 10.4509 27.9995 14.1217C27.9676 17.7924 26.4952 21.3038 23.8995 23.8995C21.3038 26.4952 17.7924 27.9676 14.1217 27.9995C10.4509 28.0314 6.91447 26.6202 4.27404 24.07ZM16.132 14.172L20.094 10.21L18.12 8.23603L14.172 12.198L10.21 8.23603L8.23603 10.21L12.198 14.172L8.23603 18.134L10.21 20.108L14.172 16.146L18.134 20.108L20.108 18.134L16.146 14.172H16.132Z"
                            fill="white" />
                    </svg>
                 </div>
                <div class="popLeft">
                    <div class="popContent">
                        <div class="discountHeading">
                            <h2>You're Already Subscribed</h2>
                        </div>
                        <div class="discountCaption">
                            <p>Your email is already registered. Make sure to check your inbox—you won’t want to miss our newest offers and smart tracking tips!</p>
                        </div>
                    </div>
                </div>
                <div class="popSideimage">
                    <img src="https://cdn.shopify.com/s/files/1/0910/8966/6336/files/banner-shirt2_jpg.webp?v=1731580104"
                        alt="">
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // ========== Widget & Modal Elements ==========
  const widgetIcon = document.createElement("div");
  widgetIcon.id = "popupWidgetIcon";
  widgetIcon.style.position = "fixed";
  widgetIcon.style.bottom = "20px";
  widgetIcon.style.left = "20px";
  widgetIcon.style.zIndex = "9999";
  widgetIcon.style.cursor = "pointer";
  widgetIcon.innerHTML = '<img src="https://cdn.shopify.com/s/files/1/0910/8966/6336/files/widget_myloc8.gif?v=1747208969" alt="Subscribe" width="78" height="101">'; // replace with your icon
  document.body.appendChild(widgetIcon);

  const initialModal = document.getElementById("initialPopModal");
  const confirmationModal = document.getElementById("confirmationPopModal");
  const finalModal = document.getElementById("finalPopModal");

  const closeButtons = document.querySelectorAll(".closeButton");
  const subscribeButton = document.getElementById("subscriptionButton");
  const emailInput = document.getElementById("subscriptionEmail");
  const termsCheckbox = document.querySelector("#popTermss input");

  // ========== Helpers ==========
  const showModal = (id) => {
    [initialModal, confirmationModal, finalModal].forEach((modal) =>
      modal.style.display = "none"
    );
    document.getElementById(id).style.display = "block";
  };

  const hideAllModals = () => {
    [initialModal, confirmationModal, finalModal].forEach(
      (modal) => (modal.style.display = "none")
    );
  };

  const isEmailValid = (email) => {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  };

  const isExcludedPage = () => {
    const path = window.location.pathname;
    return path.includes("/cart") || path.includes("/checkout");
  };

  const checkIfCustomerExists = async (email) => {
    const res = await fetch("/account/login", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: `form_type=customer_login&customer[email]=${encodeURIComponent(
        email
      )}&customer[password]=wrong-password`,
    });

    const html = await res.text();
    return html.includes("Incorrect") || html.includes("No account found");
  };

  const createCustomer = async (email) => {
    await fetch("/account", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: `form_type=create_customer&customer[email]=${encodeURIComponent(
        email
      )}&customer[tags]=popup-subscriber`,
    });
  };

  // ========== Widget Click Logic ==========
  widgetIcon.addEventListener("click", () => {
    showModal("initialPopModal");
  });

  // ========== Close Button Logic ==========
  closeButtons.forEach((btn) =>
    btn.addEventListener("click", () => hideAllModals())
  );

  // ========== Subscription Logic ==========
  subscribeButton.addEventListener("click", async () => {
    const email = emailInput.value.trim();

    if (!isEmailValid(email)) {
      alert("Please enter a valid email.");
      return;
    }

    if (!termsCheckbox.checked) {
      alert("You must agree to the privacy policy.");
      return;
    }

    const customerExists = await checkIfCustomerExists(email);

    if (customerExists) {
      showModal("finalPopModal");
    } else {
      await createCustomer(email);
      showModal("confirmationPopModal");
    }

    // Optional: Add analytics here
    // gtag('event', 'subscribe', { method: 'popup_widget', email: email });
    // fbq('trackCustom', 'PopupSubscription', { email: email });
  });

  // ========== Auto Trigger on First Visit ==========
  if (!isExcludedPage()) {
    setTimeout(() => {
      showModal("initialPopModal");
    }, 5000); // 5 seconds after page load
  }



 
  // const emailError = document.getElementById('emailError');
  // const termsError = document.getElementById('termsError');

  // function validateEmail(email) {
  //   const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  //   return re.test(String(email).toLowerCase());
  // }

  // subscribeButton.addEventListener('click', function (e) {
  //   let isValid = true;
  //   emailError.style.display = 'none';
  //   termsError.style.display = 'none';

  //   const emailValue = emailInput.value.trim();
  //   const isTermsChecked = termsCheckbox.checked;

  //   if (!emailValue) {
  //     emailError.textContent = "Email is required.";
  //     emailError.style.display = 'block';
  //     isValid = false;
  //   } else if (!validateEmail(emailValue)) {
  //     emailError.textContent = "Please enter a valid email address.";
  //     emailError.style.display = 'block';
  //     isValid = false;
  //   }

  //   if (!isTermsChecked) {
  //     termsError.textContent = "You must agree to the terms to continue.";
  //     termsError.style.display = 'block';
  //     isValid = false;
  //   }

  //   if (!isValid) {
  //     e.preventDefault(); // Stop form or ajax from submitting
  //     return;
  //   }

  //   // If valid, you can proceed with your fetch/ajax submission here
  //   // OR let the form submit if it's wrapped in a <form>
  // });


  
});
</script>
                          
  <style>
    #popupWidgetIcon {
      position: fixed;
      bottom: 20px;
      left: 35px;
      z-index: 9999;
      cursor: pointer;
    }
    #initialPopModal, #confirmationPopModal, #finalPopModal {
      display: none;
    }
    .popupOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #00000080;
      z-index: 10000;
    }

    .closeButton {
        /* display: flex; */
        /* justify-content: end; */
        /* background: antiquewhite; */
        /* position: relative; */
        /* top: 48%; */
        /* padding-bottom: 29px; */
        position: absolute;
        right: -40px;
        top: -40px;
    }


    .popupWidget {
        margin: 0;
        padding: 0;
        width: 100%;
        max-width: 1100px;
        border-radius: 20px;
        display: flex;
        position: relative;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .popContent {
        padding: 80px 60px;
        line-height: 50px;
        display: flex;
        flex-direction: column;

    }

    .popLeft {
        width: 55%;
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        align-content: center;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        background: #E9EAF0;
        border-top-left-radius: 40px;
        border-bottom-left-radius: 40px;
    }

    .discountHeading h2 {
        font-family: Circular Std;
        font-weight: 900;
        font-size: 70px;
        letter-spacing: 0;
        color: #2D3650;
        line-height: 74px;
        margin-bottom: 30px;
        margin-top: 0;
    }

    .discountHeading span {
        font-size: 110px;
    }

    .discountCaption {
        font-family: Circular Std;
        font-weight: 450;
        font-size: 26px;
        line-height: 150%;
        letter-spacing: 0;
        overflow: hidden;
        color: #232323;
    }

    .emailFields {
        padding-top: 40px;
        padding-bottom: 30px;
    }

    .emailFields input[type="email"] {
        width: 100%;
        border-radius: 30px;
        padding: 22px;
        border: 1px solid #2D3650;
    }

    .subscribeBtn input[type="submit"] {
        width: 100%;
        background: #2D3650;
        color: #FFFFFF;
        font-size: 22px;
        padding: 19px 0;
        border-radius: 30px;
        font-weight: 700;
        line-height: 24px;
        text-transform: uppercase;
        border: none;
        /* font-family: Circular Std; */
    }

    .popTerms {
        padding-top: 30px;
        color: #2D3650;
    }

    .popSideimage {
        width: 45%;
        display: flex;
        border-top-right-radius: 40px;
        border-bottom-right-radius: 40px;
        overflow: hidden;
    }

    .popSideimage img {
        width: 100%;
        object-fit: cover;
    }
  </style>
{% endif %}
